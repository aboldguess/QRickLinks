{#
  Admin pricing tier configurator for subscription limits and pricing.
  Includes special offer controls and tier management actions.
#}
{% extends 'admin_base.html' %}
{% block content %}
<h2>Pricing Tiers</h2>
<div class="alert alert-info">
  <strong>How to use this page:</strong> Update base pricing and limits, then
  optionally configure a special offer (name, discounted pricing, expiry, and
  active toggle). Offers only display while active and before the expiry date.
</div>
<form method="post">
  <!-- Admin tier changes require CSRF protection -->
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  <table class="table table-bordered text-center align-middle">
    <thead>
      <tr>
        <th>Feature</th>
        {% for tier in tiers %}
        <th>
          <input type="text" class="form-control mb-2" name="{{ tier.id }}_name" value="{{ tier.name }}">
        </th>
        {% endfor %}
        <th>
          <input type="text" class="form-control" name="new_tier_name" placeholder="New tier">
          <button class="btn btn-primary btn-sm mt-2" type="submit">Add</button>
        </th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <th>Monthly Price</th>
        {% for tier in tiers %}
        <td><input type="number" step="0.01" class="form-control" name="{{ tier.id }}_monthly_price" value="{{ tier.monthly_price }}"></td>
        {% endfor %}
        <td></td>
      </tr>
      <tr>
        <th>Yearly Price</th>
        {% for tier in tiers %}
        <td><input type="number" step="0.01" class="form-control" name="{{ tier.id }}_yearly_price" value="{{ tier.yearly_price }}"></td>
        {% endfor %}
        <td></td>
      </tr>
      <tr>
        <th>Highlight</th>
        {% for tier in tiers %}
        <td><input type="text" class="form-control" name="{{ tier.id }}_highlight_text" value="{{ tier.highlight_text }}"></td>
        {% endfor %}
        <td></td>
      </tr>
      <tr>
        <th>Special Offer Name</th>
        {% for tier in tiers %}
        <td><input type="text" class="form-control" name="{{ tier.id }}_special_offer_name" value="{{ tier.special_offer_name or '' }}"></td>
        {% endfor %}
        <td></td>
      </tr>
      <tr>
        <th>Special Offer Monthly Price</th>
        {% for tier in tiers %}
        <td><input type="number" step="0.01" class="form-control" name="{{ tier.id }}_special_offer_monthly_price" value="{{ tier.special_offer_monthly_price if tier.special_offer_monthly_price is not none else '' }}"></td>
        {% endfor %}
        <td></td>
      </tr>
      <tr>
        <th>Special Offer Yearly Price</th>
        {% for tier in tiers %}
        <td><input type="number" step="0.01" class="form-control" name="{{ tier.id }}_special_offer_yearly_price" value="{{ tier.special_offer_yearly_price if tier.special_offer_yearly_price is not none else '' }}"></td>
        {% endfor %}
        <td></td>
      </tr>
      <tr>
        <th>Special Offer Active</th>
        {% for tier in tiers %}
        <td>
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" name="{{ tier.id }}_special_offer_active" {% if tier.special_offer_active %}checked{% endif %}>
          </div>
        </td>
        {% endfor %}
        <td></td>
      </tr>
      <tr>
        <th>Special Offer Expiry</th>
        {% for tier in tiers %}
        <td>
          <input
            type="date"
            class="form-control"
            name="{{ tier.id }}_special_offer_expires_at"
            value="{{ tier.special_offer_expires_at.strftime('%Y-%m-%d') if tier.special_offer_expires_at else '' }}">
        </td>
        {% endfor %}
        <td></td>
      </tr>
      <tr>
        <th>Colour Palette</th>
        {% for tier in tiers %}
        <td>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="{{ tier.id }}_palette" value="limited" {% if not tier.full_palette %}checked{% endif %}>
            <label class="form-check-label">16 colours</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="{{ tier.id }}_palette" value="full" {% if tier.full_palette %}checked{% endif %}>
            <label class="form-check-label">Full colour</label>
          </div>
        </td>
        {% endfor %}
        <td></td>
      </tr>
      {% for feat in features %}
      <tr>
        <th>{{ feat.replace('_',' ').title() }}</th>
        {% for tier in tiers %}
        <td>
          <div class="input-group">
            <input type="number" class="form-control" name="{{ tier.id }}_{{ feat }}_limit" value="{{ getattr(tier, feat + '_limit') }}">
            <div class="input-group-text">
              <input type="checkbox" class="form-check-input mt-0" name="{{ tier.id }}_{{ feat }}_unlimited" {% if getattr(tier, feat + '_unlimited') %}checked{% endif %}>
            </div>
          </div>
        </td>
        {% endfor %}
        <td></td>
      </tr>
      {% endfor %}
      <tr>
        <th>Actions</th>
        {% for tier in tiers %}
        <td>
          <a href="{{ url_for('delete_tier', tier_id=tier.id) }}" class="btn btn-danger btn-sm">Delete</a>
          <a href="{{ url_for('archive_tier', tier_id=tier.id) }}" class="btn btn-secondary btn-sm">{{ 'Unarchive' if tier.archived else 'Archive' }}</a>
        </td>
        {% endfor %}
        <td></td>
      </tr>
    </tbody>
  </table>
  <button type="submit" class="btn btn-primary">Save Changes</button>
</form>
{% endblock %}
